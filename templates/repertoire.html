<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Repertorio</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>
    <div id="app">
    <nav class="navbar navbar-expand-lg navbar-custom border-bottom py-3">
    <div class="container d-flex align-items-center justify-content-between">
        <a class="navbar-brand d-flex align-items-center" href="/">
            <img src="/static/LOGO.png" alt="Logo Su Presencia" class="me-3">
            <span class="fs-3 fw-bold text-dark" style="font-family: 'Oswald', sans-serif;">CANCIONES ALABANZA</span>
        </a>
        <div class="navbar-nav flex-row">
            <a class="nav-link px-3" href="/songs">Canciones</a>
            <a class="nav-link px-3" href="/repertoire">Repertorio</a>
            <a class="nav-link px-3" href="/history">Historial</a>
        </div>
    </div>
</nav>

        <div class="container mt-4">
            <h1 class="mb-4">Crear Nuevo Repertorio</h1>

            <div class="row">
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Filtros de Búsqueda</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Categoría</label>
                                <select class="form-select" v-model="selectedCategory" @change="resetFilters">
                                    <option value="su_presencia_reciente">Álbumes Recientes Su Presencia</option>
                                    <option value="nxtwave">NxtWave</option>
                                    <option value="su_presencia_antiguo">Álbumes Antiguos Su Presencia</option>
                                    <option value="otros">Otros Artistas</option>
                                </select>
                            </div>

                            <div v-if="selectedCategory === 'su_presencia_reciente'" class="mb-3">
                                <label class="form-label">Álbum</label>
                                <select class="form-select" v-model="filters.album">
                                    <option value="">Todos los álbumes</option>
                                    <option v-for="album in recentSuPresenciaAlbums" :value="album">[[ album ]]</option>
                                </select>
                            </div>

                            <div v-if="selectedCategory === 'nxtwave'" class="mb-3">
                                <label class="form-label">Álbum</label>
                                <select class="form-select" v-model="filters.album">
                                    <option value="">Todos los álbumes</option>
                                    <option v-for="album in nxtwaveAlbums" :value="album">[[ album ]]</option>
                                </select>
                            </div>

                            <div v-if="selectedCategory === 'su_presencia_antiguo'" class="mb-3">
                                <label class="form-label">Álbum</label>
                                <select class="form-select" v-model="filters.album">
                                    <option value="">Todos los álbumes</option>
                                    <option v-for="album in oldSuPresenciaAlbums" :value="album">[[ album ]]</option>
                                </select>
                            </div>

                            <div v-if="selectedCategory === 'otros'" class="mb-3">
                                <label class="form-label">Artista</label>
                                <select class="form-select" v-model="filters.artist">
                                    <option value="">Todos los artistas</option>
                                    <option v-for="artist in otherArtists" :value="artist">[[ artist ]]</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" v-model="filters.type">
                                    <option value="">Todos los tipos</option>
                                    <option value="Rápida">Rápida</option>
                                    <option value="Lenta">Lenta</option>
                                </select>
                            </div>

                            <div v-if="selectedCategory === 'otros'" class="mb-3">
                                <label class="form-label">Año mínimo</label>
                                <input type="number" class="form-control" v-model="filters.year" min="1990" :max="new Date().getFullYear()">
                            </div>

                            <button class="btn btn-primary" @click="searchSongs">Buscar Canciones</button>
                        </div>
                    </div>

                    <div class="card mb-4" v-if="filteredSongs.length > 0">
                        <div class="card-header">
                            <h5>Resultados de Búsqueda ([[ filteredSongs.length ]])</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Título</th>
                                            <th>Artista</th>
                                            <th>Álbum</th>
                                            <th>Tipo</th>
                                            <th>Año</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="song in filteredSongs" :key="song.id">
                                            <td>[[ song.title ]]</td>
                                            <td>[[ song.artist ]]</td>
                                            <td>[[ song.album ]]</td>
                                            <td>[[ song.type ]]</td>
                                            <td>[[ song.year ]]</td>
                                            <td>
                                                <button class="btn btn-sm btn-success"
                                                        @click="addToRepertoire(song)"
                                                        :disabled="repertoireSongs.some(s => s.id === song.id)">
                                                    [[ repertoireSongs.some(s => s.id === song.id) ? 'Agregada' : 'Agregar' ]]
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-header">
                            <h5>Repertorio Actual</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Nombre del Repertorio</label>
                                <input type="text" class="form-control" v-model="repertoireName" placeholder="Ej: Domingo 15 de Enero">
                            </div>

                            <div class="mb-3">
                                <p>Total de canciones: [[ repertoireSongs.length ]]</p>
                                <p>Rápidas: [[ countByType('Rápida') ]]</p>
                                <p>Lentas: [[ countByType('Lenta') ]]</p>
                            </div>

                            <div v-if="repertoireSongs.length > 0" class="mb-3">
                                <h6>Lista de canciones:</h6>
                                <ol class="list-group list-group-numbered">
                                    <li v-for="(song, index) in repertoireSongs" :key="song.id"
                                        class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="ms-2 me-auto">
                                            <div class="fw-bold">[[ song.title ]]</div>
                                            [[ song.artist ]] - [[ song.album ]]
                                        </div>
                                        <button class="btn btn-sm btn-danger" @click="removeFromRepertoire(index)">×</button>
                                    </li>
                                </ol>
                            </div>

                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-success"
                                        @click="saveRepertoire"
                                        :disabled="repertoireSongs.length === 0 || !repertoireName">
                                    Guardar Repertorio
                                </button>
                                <button class="btn btn-secondary"
                                        @click="generatePDF"
                                        :disabled="repertoireSongs.length === 0">
                                    Generar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/script.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    selectedCategory: 'su_presencia_reciente',
                    filters: {
                        artist: '',
                        album: '',
                        type: '',
                        year: ''
                    },
                    recentSuPresenciaAlbums: ['Fragmentos Del Cielo', 'Jesús', 'Tienes El Control', 'Adora 24/7CD 1', 'Adora 24/7CD 2'],
                    nxtwaveAlbums: ['NxtWave', 'We Are The Revolution', 'Burning flame'],
                    oldSuPresenciaAlbums: ['Cielos Abiertos - Voy Buscando', 'Jesus Freak', 'Vive En Mí', 'Fiel', 'Él', 'Himnos'],
                    otherArtists: ['Planet Shakers', 'Hillsong Worship', 'Elevation Worship', 'Marcos Witt', 'Danilo Montero', 'Israel & New Breed', 'Chris Tomlin', 'Kari Jobe', 'Bethel Music', 'Hillsong United', 'Jesus Culture', 'Miel San Marcos', 'Un Corazón', 'Marcela Gándara', 'Alex Campos', 'Christine D\'Clario', 'Thalles Roberto', 'Kike Pavón', 'Generación 12', 'Ron Kenoly', 'Michael W. Smith', 'Darlene Zschech', 'Phil Wickham', 'VOUS Worship', 'UPPERROOM', 'Maverick City Music', 'Soluciones Live', 'Rojo', 'Juan Luis Guerra', 'Marco Barrientos', 'En Espíritu Y En Verdad', 'Maranatha Music', 'The Katinas', 'Israel Houghton', 'Montesanto', 'Passion', 'Lead', 'Gateway Worship Español', 'Bridge Worship', 'Sarai Rivera', 'Jacobo Ramos', 'Franky Arango', 'Walter Rumierk', 'Miguel Cassina', 'Fernando Solares', 'Hector Sotelo', 'Sarahanne Wilmont', 'Clint Brown', 'Evan Craft', 'David Scarpeta', 'Johan Y Sofi', 'Marcos Vidal', 'Marcos Brunet', 'Freddy Rodríguez', 'Gilberto Daza', 'Christina Aguilera', 'Desconocido'],
                    filteredSongs: [],
                    repertoireSongs: [],
                    repertoireName: '',
                    allSongs: []
                }
            },
            methods: {
                resetFilters() {
                    this.filters = { artist: '', album: '', type: '', year: '' };
                    this.filteredSongs = [];
                },
                searchSongs() {
                    let params = new URLSearchParams();
                    if (this.selectedCategory === 'su_presencia_reciente') {
                        params.append('artist', 'Su Presencia');
                        if (this.filters.album) params.append('album', this.filters.album);
                    } else if (this.selectedCategory === 'nxtwave') {
                        params.append('artist', 'NxtWave');
                        if (this.filters.album) params.append('album', this.filters.album);
                    } else if (this.selectedCategory === 'su_presencia_antiguo') {
                        params.append('artist', 'Su Presencia');
                        if (this.filters.album) params.append('album', this.filters.album);
                    } else if (this.selectedCategory === 'otros') {
                        if (this.filters.artist) params.append('artist', this.filters.artist);
                        if (this.filters.year) params.append('year', this.filters.year);
                    }
                    if (this.filters.type) params.append('type', this.filters.type);
                    fetch(`/api/filter/songs?${params.toString()}`)
                        .then(res => res.json())
                        .then(data => { this.filteredSongs = data; });
                },
                addToRepertoire(song) {
                    if (!this.repertoireSongs.some(s => s.id === song.id)) {
                        this.repertoireSongs.push(song);
                    }
                },
                removeFromRepertoire(index) {
                    this.repertoireSongs.splice(index, 1);
                },
                countByType(type) {
                    return this.repertoireSongs.filter(song => song.type === type).length;
                },
                saveRepertoire() {
                    const songIds = this.repertoireSongs.map(song => song.id);
                    fetch('/api/repertoire', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: this.repertoireName,
                            song_ids: songIds
                        })
                    }).then(res => {
                        if (res.ok) {
                            alert('Repertorio guardado exitosamente');
                            this.repertoireSongs = [];
                            this.repertoireName = '';
                        }
                    });
                },
                generatePDF() {
                    const songIds = this.repertoireSongs.map(song => song.id);
                    const name = this.repertoireName || 'repertorio';
                    fetch(`/api/repertoire/0/pdf?name=${encodeURIComponent(name)}&songs=${songIds.join(',')}`)
                        .then(res => res.blob())
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${name}.pdf`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                        });
                }
            },
            mounted() {
                fetch('/api/songs')
                    .then(res => res.json())
                    .then(data => { this.allSongs = data; });
            }
        });

        app.config.compilerOptions.delimiters = ['[[', ']]'];
        app.mount('#app');
    </script>
</body>
</html>